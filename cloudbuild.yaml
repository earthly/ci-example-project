steps:
  - id: 'build'
    name: 'earthly/earthly:v0.8.0'
    env:
      - "HOME=/root"
    args:
      - --allow-privileged
      - --ci
      # - --push # Uncomment to allow GCP to push images to your choice of repository. Secrets for your repository must be configured.
      - +docker
  
  - id: 'secrets'
    name: 'earthly/earthly:v0.8.0'
    entrypoint: earthly secrets ls
    secretEnv:
      - 'EARTHLY_TOKEN'

  - id: 'gcp-test'
    name: 'earthly/earthly:v0.8.0'
    env:
      - "HOME=/root"
      - "EARTHLY_PROJECT=cloud"
    args:
      - +gcp-cloudbuild
    secretEnv:
      - 'EARTHLY_TOKEN'
    
availableSecrets:
  secretManager:
  - versionName: projects/earthly-jupyterlab/secrets/EARTHLY_TOKEN/versions/2
    env: 'EARTHLY_TOKEN'
